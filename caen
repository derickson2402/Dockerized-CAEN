#!/bin/bash

# Define our help message, docker flags, and env vars
CAEN_DEFAULT_ARGS="--rm -it --name caen-tainer -e TERM=${TERM} -v $(pwd):/code"
HELP_MESSAGE=$(cat << EOF
Helper script for Dockerized-CAEN. To use, run the following:

   ./caen <program> [args]

For example, running the following would run Valgrind on an
executable called 'program.exe' with a '--flag' and input from a file:

   ./caen valgrind program.exe --flag < input.txt

You can specify a specific version of the container to run with the
\$CAEN_VERSION environment variable like so:

    CAEN_VERSION=dev caen valgrind

EOF
)

# Get OS information
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    HOST_OS=linux
elif [[ "$OSTYPE" == "darwin"* ]]; then
    HOST_OS=mac
elif [[ "$OSTYPE" == "cygwin"* ]] | [[ "$OSTYPE" == "msys" ]]; then
    HOST_OS=windows
else
    echo -e "Uh Oh!! We couldn't figure out what computer you're running..."
    echo -e "You can probably still run the container manually though, check"
    echo -e "out the GitHub page for help!"
    echo -e "\n\thttps://github.com/derickson2402/Dockerized-CAEN"
    exit
fi

# Make sure that Docker Engine is installed and running
if ( ! command -v docker &> /dev/null ); then
    echo -e "Heads up! Docker is not installed on your computer!"
    echo -e "You can download and install it here:"
    if [[ "$HOST_OS" == "windows" ]]; then
        echo -e "\n\thttps://docs.docker.com/desktop/#download-and-install"
    elif [[ "$HOST_OS" == "mac" ]]; then
        echo -e "\n\thttps://docs.docker.com/desktop/mac/install/"
    else
        echo -e "\n\thttps://docs.docker.com/engine/install/"
    fi
    exit
elif ( ! docker stats --no-stream &> /dev/null ); then
    echo -e "Waking up Moby the Whale..."
    if [[ "$HOST_OS" == "mac" ]]; then
        open /Applications/Docker.app
    elif [[ "$HOST_OS" == "windows" ]]; then
        /mnt/c/Program\ Files/Docker/Docker/resources/dockerd.exe
    elif [[ "$HOST_OS" == "linux" ]]; then
        sudo systemctl start docker
    fi
    sleep 5
    declare -i counter=0
    while ( ! docker stats --no-stream &> /dev/null ); do
        (( counter += 1 ))
        echo -e "Waiting for Moby the Whale to wake up..."
        sleep 10
        if [[ counter -gt 2 ]]; then
            echo -e "Couldn't wake up Moby :("
            echo -e "Maybe try restarting Docker?"
            exit
        fi
    done
fi

# Process the CLI args, set default vars, and get the specified program
if [ $# -eq 0 ]; then
    echo -e "$HELP_MESSAGE" && exit
fi
if ( wget -q --spider http://github.com ); then
    CAEN_DEFAULT_ARGS="$CAEN_DEFAULT_ARGS --pull always"
fi
PROGRAM=$1
shift
case $PROGRAM in
    help)
        echo -e "$HELP_MESSAGE" && exit
        ;;
    perf)
        echo -e "Heads up! Perf requires SYS_ADMIN Docker capabilities to run."
        echo -e "You should only do this with code that you trust!"
        read -p "Hit [Ctrl+c] to cancel, or enter to continue" </dev/tty
        CAEN_DEFAULT_ARGS="$CAEN_DEFAULT_ARGS --privileged --cap-add SYS_ADMIN"
        ;;
esac
shift

# Execute the given program and its args using the CAEN container
docker run $CAEN_DEFAULT_ARGS $CAEN_ARGS ${CAEN_REPO_NAME:=ghcr.io/derickson2402/dockerized-caen}:${CAEN_VERSION:=latest} $PROGRAM $@

